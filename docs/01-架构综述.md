# 架构综述（Plus-Vben5 & RuoYi-Vue-Plus）

> 版本：v1.0（2025-10-26）

本综述汇总前后端与 AI 服务的基座框架、运行约束与集成边界。所有技术决策均可追溯到公开框架文档或内部规范，便于评审与维护。

## 1. 技术选型概览

| 层级 | 框架/技术 | 核心职责 | 参考来源 |
| ---- | --------- | -------- | -------- |
| 前端 | Plus-Vben5（Vue 3 + TypeScript + Vite + Pinia）+ Ant Design Vue | 管理界面、实时会话、组件库 | [Plus-Vben5 快速开始](https://dapdap.top/guide/quick-start.html)、[Ant Design Vue 组件](https://www.antdv.com/components/statistic) |
| 后端 | RuoYi-Vue-Plus（Spring Boot 3 + Undertow + MyBatis-Plus + Sa-Token） | 多租户进销存 API、权限、日志与任务调度 | [RuoYi-Vue-Plus 文档](https://plus-doc.top#/ruoyi-vue-plus/home) |
| AI 服务 | FastAPI + LangChain + LangGraph | 意图解析、查询合成、洞察生成，受限输出结构化请求 | 内部规范 |
| 基础设施 | Redis/Redisson、dynamic-datasource、HikariCP、SnailJob、MinIO、OpenTelemetry、Prometheus | 缓存、数据源管理、连接池、调度、对象存储与可观测性 | 宪章约束 |

## 2. 前端基座（Plus-Vben5）

- **目录结构**：前端代码位于 `frontend/apps/web-antd/`，遵循 Vben5 单仓工作区布局；Lint、格式化、Turbo 构建配置拆分到 `frontend/internal/` 与 `frontend/packages/`。
- **运行环境**：要求 Node.js ≥ 20.15 与最新 `pnpm`，以 `pnpm install` 安装依赖，使用 `pnpm run dev:antd` 启动开发服务器（默认端口 5666）。
- **配置重点**：
  - `.env.*` 文件维护 API 代理与安全参数，`VITE_GLOB_ENABLE_ENCRYPT` 控制前后端 RSA 加解密；需维护两对公私钥分别用于“请求加密/后端解密”与“后端加密/响应解密”。
  - `VITE_GLOB_WEBSOCKET_ENABLE` 控制 WebSocket 客户端启用；开启后，聊天界面需带上租户/用户上下文与 `correlationId`。
  - `VITE_NITRO_MOCK`、`VITE_DEVTOOLS` 等配置用于切换本地 Mock 与 DevTools 工具链。
- **组件生态**：
  - UI 基于 Ant Design Vue，统计类组件（如 `Statistic`）用于进销存 KPI 与仪表看板；需结合 ECharts 实现图表呈现。
  - 图标系统使用 Iconify，支持脚本批量替换菜单图标（`scripts/菜单图标替换sql/update_icon.sql`）。
- **工程规范**：Vben5 推荐 VS Code 插件（ESLint、Prettier、Iconify IntelliSense 等），本仓库在工作区配置中统一声明。

## 3. 后端基座（RuoYi-Vue-Plus）

- **模块划分**：
  - `ruoyi-admin`：承载主 Web 层、OpenAPI（SpringDoc）与 Sa-Token 认证逻辑。
  - `ruoyi-common-*`：通用组件（Core、MyBatis、Security、Redis、Job、OSS 等），负责多租户、数据权限、加密、Excel 导入导出与日志审计。
  - `ruoyi-modules`：扩展业务模块（system、job、workflow、generator 等），本项目将在此基础上新增进销存领域模块。
  - `ruoyi-extend`：包含监控与 SnailJob 扩展服务，支撑事件调度与后台任务。
- **运行特性**：
  - 默认 Undertow 容器 + 虚拟线程模式，配合 HikariCP 与 dynamic-datasource 实现多数据源管理。
  - 认证授权基于 Sa-Token + JWT，配合 Redis/Redisson 完成会话、缓存与分布式锁。
  - SnailJob 负责异步调度，事件日志与审计日志写入独立存储；MinIO 提供对象存储。
- **开发要求**：
  - 使用 Maven 作为构建工具，推荐开启 Spotless/Checkstyle 保持代码格式。
  - MyBatis-Plus 插件启用多租户、分页、数据权限（DataScope）与乐观锁等能力，所有 Mapper 需明确租户字段过滤。
  - SpringDoc 自动生成 API 文档，需同步输出契约 JSON Schema 以便前端与 AI 服务复用。

## 4. AI 服务边界

- **职责限制**：AI 服务不直接访问数据库，仅输出 `BusinessRequest` / `SQLRequest` 等结构化意图，由后端受控执行。
- **技术栈**：FastAPI + LangChain + LangGraph，使用 uv / Poetry 管理依赖；Pytest + Ruff 确保质量。
- **安全策略**：所有出入站消息携带签名与遥测（延迟、模型版本、置信度），AI 结果必须提供可追溯数据来源。

## 5. 跨层集成

```
前端 (Plus-Vben5)
  ├─ WebSocket 客户端：/ws/conversation
  ├─ REST API：配置、报表导出、鉴权令牌刷新
  └─ 加解密：RSA + 对称密钥轮换
        ↓
后端 (RuoYi-Vue-Plus)
  ├─ 网关控制层：租户上下文拦截器、Sa-Token 认证
  ├─ 命令/查询分离：CQRS + 事件总线
  ├─ 业务域：进销存、报表、审批流
  └─ 可观测性：OpenTelemetry + Prometheus
        ↓
AI 服务
  ├─ 意图解析（LangGraph）
  ├─ 防护策略（SQL 白名单 + 审批状态机）
  └─ 洞察生成（InsightPayload）
```

## 6. DevOps 与可观测性

- **部署拓扑**：前后端分仓，通过统一 CI/CD 管道（Turbo & pnpm、Maven、uv）完成构建。推荐使用 Docker Compose/Helm 将前端静态资源（Nginx）、后端 Spring Boot 服务与 AI FastAPI 服务分容器部署，同时挂载 Redis、MinIO、Prometheus 等依赖。
- **监控指标**：
  - 前端：WebSocket 连接成功率、消息延迟、Ant Design 组件渲染性能。
  - 后端：API p95 延迟、虚拟线程队列长度、数据源切换耗时、SnailJob 执行状态。
  - AI 服务：模型响应时间、置信度分布、SQLRequest 拒绝率。
- **日志追踪**：统一 `correlationId`，贯穿浏览器、后端与 AI 服务；接入 OpenTelemetry Trace + Prometheus 指标 + Loki/Elastic（可选）。

## 7. 更新记录

- 2025-10-26：首次编写，整合 Plus-Vben5、Ant Design Vue 与 RuoYi-Vue-Plus 文档要点，明确多服务通信与安全边界。

# 功能 002：智能分析问询系统 — 需求规格

> 版本：v0.1（2025-10-26）

## 1. 概述

- **特性编号**：002-intelligent-querying
- **目标阶段**：建立在功能 001 的进销存数据之上，提供自然语言问询、洞察生成与运营助手能力。
- **架构依赖**：前端 Plus-Vben5（聊天界面、洞察面板）、后端 RuoYi-Vue-Plus（WebSocket 网关、权限校验）、AI 服务（FastAPI + LangChain + LangGraph）。

## 2. 业务价值

| 指标 | 目标值 | 说明 |
| ---- | ------ | ---- |
| 问询成功率 | ≥ 90% | 用户请求获得明确响应（含澄清或审批提示）。
| 响应延迟 | p95 ≤ 3s | WebSocket 往返，含 AI 推理与后端执行。
| 审批完成率 | ≥ 95% | 需审批的 SQL 请求在 SLA 内处理完成。

## 3. 用户画像与场景

- **数据分析师**：跨租户或跨维度分析（需审批），关注数据准确性与可追溯性。
- **运营经理**：实时获取销售、库存洞察，订阅指标波动提醒。
- **审计员**：审查 AI 问询记录、SQL 审批轨迹、洞察溯源。

主要场景：
1. 自然语言查询销售/库存数据，收到表格、图表、洞察卡片。
2. 触发 SQL 审批流程，待人工确认后继续执行。
3. 订阅 KPI 异常提醒，AI 提供可操作建议。
4. 查看会话历史、导出洞察报告。

## 4. 功能需求

1. **会话管理**
	- WebSocket 会话 / REST 回放接口。
	- 会话保留策略：最近 90 天，支持租户内多用户共享上下文。
	- 会话内消息类型：`USER_QUERY`、`AI_RESPONSE`、`SQL_APPROVAL_REQUEST`、`APPROVAL_DECISION`、`INSIGHT_TELEMETRY`。
2. **意图解析**
	- LangGraph 流程：语言理解 → 意图分类 → 数据安全检查 → 请求生成。
	- 分类结果：`BUSINESS_METRIC`、`SQL_REQUIRED`、`NON_SUPPORTED`。
	- 输出带置信度分数及 `justification` 字段。
3. **SQL 防护**
	- 规则白名单（表/字段）、正则过滤（禁止 `DROP`、`UNION SELECT` 等）。
	- 审批状态机：`PENDING` → (`APPROVED`|`REJECTED`) → `EXECUTED`。
	- 审批结果推送至 WebSocket，并记录不可篡改日志。
4. **洞察输出**
	- `InsightPayload` 包含：摘要、数据来源、可视化描述、建议行动、置信度。
	- 支持返回 `TableDescriptor`、`ChartDescriptor`、`InsightText`。
	- 需提供延迟、数据快照版本等遥测信息。
5. **可观察性与审计**
	- 记录每次问询的输入/输出、模型版本、耗时。
	- 提供审计查询 API，支持按租户、用户、时间过滤。

## 5. 非功能需求

| 类别 | 约束 |
| ---- | ---- |
| 性能 | AI 推理链路 p95 ≤ 3s；批量洞察生成（最多 5 个并发）p95 ≤ 6s。 |
| 安全 | 禁止直接执行 AI 生成的 SQL；所有敏感操作需审批与日志。 |
| 可用性 | AI 服务失败时提供人工 fallback（静态报表、FAQ）。 |
| 可观测性 | Trace 包含 AI 节点耗时、置信度分布；Prometheus 记录审批队列长度。 |

## 6. 集成约束

- 仅在功能 001 数据域范围内提供洞察；不新增跨域数据源。
- AI 模块以独立服务运行，通过 WebSocket/REST 与后端交互，不直接访问数据库。
- 输出契约必须遵循 `.specify/specs/shared/schemas/` 中共享的 JSON Schema。

## 7. 澄清记录

- `[NEEDS CLARIFICATION]` KPI 异常检测阈值是否可由运营配置？
- `[NEEDS CLARIFICATION]` 是否需要语音输入或只支持文本。

## 8. 验收标准

- 用户可以自然语言检索进销存指标，并获得结构化回复及可视化元素。
- SQL 审批流程可在控制台完成，AI 回复可引用审批结果。
- 审计日志中可追溯每次问询的原始文本、生成 SQL、执行状态与模型版本。

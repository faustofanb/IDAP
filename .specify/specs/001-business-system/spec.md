# 功能 001：进销存业务系统 — 需求规格

> 版本：v0.1（2025-10-26）

## 1. 概述

- **特性编号**：001-business-system
- **目标阶段**：M1（基础模块可运行），M2（核心流程闭环），M3（报表与权限精细化）
- **参考架构**：前端 Plus-Vben5（Ant Design Vue），后端 RuoYi-Vue-Plus，AI 服务独立。
- **外部约束**：多租户隔离、Sa-Token + JWT 认证、RSA 请求加解密、结构化 JSON 契约。

## 2. 业务价值

| 指标 | 目标值 | 说明 |
| ---- | ------ | ---- |
| 库存准确率 | ≥ 99% | 定义为系统库存与盘点差异率。
| 订单处理效率 | +40% | 对比旧系统的订单从创建到审核时长。
| 报表生成时延 | ≤ 5s p95 | 从用户提交到前端展示的时间。

## 3. 角色与权限

- **租户所有者**：配置租户参数、查看全局报表、审核高风险操作。
- **机构管理员**：维护部门/岗位、审批采购与销售单、管理库存调整。
- **普通业务员**：录入采购/销售单、查看本人数据。
- **审计员**：只读访问审计日志与关键报表。

每个角色与租户/机构绑定，权限通过角色 + 数据范围（行/列过滤）定义。

## 4. 核心用例

1. **采购流程**：创建采购单 → 审核 → 入库 → 生成应付账款。
2. **销售流程**：创建销售单 → 审核 → 出库 → 生成应收账款。
3. **库存管理**：盘点、调拨、退货、预警配置（低库存、效期）。
4. **主数据维护**：货品、供应商、客户、仓库、计量单位。
5. **报表与 KPI**：库存余额表、销售毛利分析、供应商绩效、统计组件（Ant Design `Statistic`）。
6. **系统支撑**：租户配置、机构树、菜单 & 权限、审计追踪。

## 5. 交互与界面

- 前端采用 Ant Design Vue + ECharts，实现表格、图表、洞察卡片、KPI 指标。
- 主导航与权限通过菜单路由配置，图标使用 Iconify。
- WebSocket 渠道：`/ws/conversation` 供 AI 洞察与实时通知；REST 接口用于 CRUD、导出与报表异步任务。
- 需提供加解密状态指示与 RSA 配置检查提示。

## 6. 数据与契约

- **主数据表**：`tenant`、`org_unit`、`user_account`、`product`、`warehouse`、`inventory_balance`、`purchase_order`、`sales_order` 等。
- **租户上下文**：所有数据表需携带 `tenant_id`，查询默认强制过滤。
- **事件**：
	- `inventory.low_stock`（出库后库存低于阈值）。
	- `order.lifecycle.changed`（采购/销售单状态迁移）。
- **JSON Schema**：`RequestEnvelope`、`BusinessRequest`、`SQLRequest`、`InsightPayload` 由 `contracts/` 提供，可供前后端与 AI 服务共用。

## 7. 非功能需求

| 类别 | 约束 |
| ---- | ---- |
| 性能 | API/WS 往返 p95 ≤ 1.5s，批量导出 10 万行以内耗时 ≤ 60s。
| 安全 | RSA 请求加密默认启用；JWT 失效刷新窗口 5 分钟；敏感操作需二次确认。
| 可用性 | 关键模块单元测试覆盖率 ≥ 70%，契约测试覆盖核心 API；支持灰度开关。
| 可观测性 | OpenTelemetry Trace + Prometheus 指标 + 不可篡改审计日志。

## 8. 风险与假设

- **假设**：租户主数据已初始化；外部 ERP 同步接口后续迭代接入。
- **风险**：
	- RSA 密钥管理不当导致密文解析失败 → 需建立密钥轮换机制。
	- 多租户数据隔离配置遗漏 → 引入自动化测试验证 `tenant_id` 过滤。
	- 库存计算逻辑复杂，需准备对账脚本和可回放事件。

## 9. 澄清记录

- `[NEEDS CLARIFICATION]` 与第三方财务系统的对接协议待确认。

## 10. 验收标准

- 采购/销售/库存流程可闭环（含审核、库存更新、报表刷新）。
- 报表与 KPI 支持租户切换即时刷新；WebSocket 洞察消息带 `correlationId`。
- 审计日志记录所有敏感操作，支持按租户与时间过滤。
